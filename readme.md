-config.yaml ## 配置文档（通用）
-structurize_files.py  ## 文本结构化
-pre_labeling.py  ## 对结构化的文本进行预标注（字典和模型）
-generation.py  ## 再预标注的基础上进行一些规则合并，并进行训练数据生成
-multi_source_ner.py  # 单个语料NER模型训练，可以通过参数选择使用何语料进行训练，或者选择是从初始训练还是继续训练
-multi_ner_prediction.py  # 利用训练好的多个语料的模型，在各个语料测试集上分别进行预测并得到评价矩阵
-ensemblePrediction_all.py  # 结合评价矩阵，利用多语料多个模型对全量语料进行标注并进行相关的集成。
-clean_and_save.py  # 标注的后续处理工作，包括后期清洗，生成规则合并的实体，各个表的存储等
-utils.py   ## 其他功能函数
-app_multi.py  # 模型API
-data ## 
    -Juli   # 进行字典和ner模型预标注后的数据（json格式），以来源板块划分分别存储
    -Juli_cleaned # 清洗后的数据
    -reformatted   ## 格式转化后的数据
-input_data				## 原始训练数据
    -books_m			# 操作手册路径
    -books_n			# 临床指南路径
    -textbooks   #  原始pdf形式的书
    -textimagaes  ## 转化为图片形式的书
    -drugs_all.csv	# 药瓶说明书表
    -labs.csv     # 资料库：实验室检查
    -examinations.csv   #资料库：检验
    -surgeries.csv  #资料库： 手术
    -diseases.csv    #资料库： 疾病
-dicitionaries
    -sougou			# 搜狗词库文档
    -2022_full.json		# 全量字典json文件
    -2022.txt			# 全量字典(jieba分词用)实体代码映射关系见config.yaml
    -exclusions.txt		# 停止词
    -refined.txt			# 精炼字典
-ner					## ner模型模块，相关python文件和模型存储
    -cond_data_manager.py	## ner模型训练数据处理和批次化
    -cond_model.py		## CNN-LSTM-CRF模型结构代码
    -utils.py			## 模型评估，标注标签获取等效用函数
    -predict.py			# 预测相关(无用)
    -data     # 训练数据
        -new_training  #各个语料源和全量数据的训练/验证/测试数据
    -models			# 模型存储和评估路径
        -model_2022		# 多语料模型存储路径
        -evaluation        # 多语料模型评估结果（分别保存）
    -ner_results	  		# 模型标注的一些中间结果存储路径
        -final   		# 最终结果存储路径（和数据库一致）
    -ner_evaluation 		# ner结果评估模块
        -ner_eval.py    	# ner MUC评估矩阵。
    - logs                    #  ner模型训练相关log文件存储路径
    - manual_labeling  # 人工标注数据集待标注数据

-docextractor 			## 临床路径抽取模块
    -doc 				# 说明文档
    -data 				## 临床路径文件
    -Libs 				# 标注处理所需的文件
    -all_ExtractKnowledgeViaDocx.py	# 对临床路径进行标注
-results #结果文档
    -groups.csv  #禁忌人群的抽取结果
-hospitalization_sequentials # 就诊序列一致性分析的jupyter文件
-data_archive  #其他暂时用不到的数据归档
-code_archive  #其他暂时用不到的代码归档

1.     Structurize_files.py
主要功能：对临床指南，操作手册，药品说明书等文档进行结构化，转化为csv形式
使用场景：初次预处理时，结果会进行存储，生产中无需再使用，除非有新的文档。

2. pre_labeling.py 
主要功能：1. 利用字典（存储在dictionaries路径中）对结构化的文本数据进行预标注，以便后续生成NER训练数据。同时可以通过其中的参数选择是否同时利用训练好的NER模型来辅助标注。
          分别对 临床指南，操作手册，药品说明书， 资料库进行处理，得到json文件。其中ner结果和字典分词结果分别存储为dic的不同的key中。
          每条句子生成的形式为 (注意这里seg和ner的结果在边界的index上可能有点不一致，一个index包含最后字符一个不包括，后续还要处理)：
                    'book': '心血管分册.txt',
                    'location': '|第一章心力衰竭|第一节慢性心力衰竭',
                    'paragraph': 'clinical',
                    'sentence': '【临床表现】常见症状①呼吸困难:肺淤血所致,依病情不同可出现劳力性呼吸困难,夜间阵发性呼吸困难,甚至端坐呼吸',
                    'entity1': '慢性心力衰竭',
                    'seg': [['【', 'x', [0, 1]],
                      ['临床表现', 'i', [1, 5]], ..., 
                      ['呼吸困难', 'ds', [11, 15]],
                      ...]],
                    'ner': [['呼吸困难', 'SYM', [11, 14], [0.7744848407083914, 0.9460845777994957]],
                      ['肺淤血', 'DIS', [16, 18], [0.7440568890117892, 0.9224377721677368]],
                      ['劳力性呼吸困难', 'SYM', [30, 36], [0.920548668509957, 0.9530912794173739]], ...]]
          2. 药品说明书的人群禁忌知识直接抽取并且存储在results文件夹中。
使用场景：模型训练。用于训练NER模型前的初步训练数据生成

3. generation.py 
主要功能：pre_labeling.py 得到json文件后，对标注结果进行后续处理。后续处理内容包括：
        1. 将NER结果和字典匹配结果进行合并整理，并取较大边界作为结果。如： ner:['劳力性呼吸困难'], seg:['呼吸困难'] ====> seg ['劳力性呼吸困难']
        2. 利用规则对实体进行合并，如：人体组织结构 + 临床表现 = 临床表现，疾病 + 观测操作 = 观测操作等。例如 胸部(ORG)X光(观测操作)===>胸部X光（观测操作）。
        会进行数轮迭代。
        3. 后续清洗，某些不合适的实体去除
        4. 分别划分训练，测试，验证集并且存储。

使用场景：模型训练。用于训练NER模型前最后一步的训练数据生成

4. multi_source_ner.py  # 单个语料NER模型训练，可以通过参数选择使用何语料进行训练，或者选择是从初始训练还是继续训练
主要功能：
        对单个语料（a:全量数据， m:操作手册 c：临床指南 kd：知识库 d：药品说明书）语料进行训练，生成模型并存储到相应的路径。
        可以从0开始训练，也可以对基础模型进行继续训练。
        最重要的参数包括：cp 语料类型，a:全量数据， m:操作手册 c：临床指南 kd：知识库 d：药品说明书
                        ag 是否使用数据增强，默认为0
                        l 是否使用继续学习，默认为0不适用，如果使用那么会从指定目录读取相应语料训练出的已有的模型继续训练。
                        其他参数查看代码详情。

使用场景：模型训练。多语料模型分别训练。训练多个模型后可供后续模型评估，知识生产等工作。

5. multi_ner_prediction.py  # 利用训练好的多个语料的模型，在各个语料测试集上分别进行预测并得到评价矩阵
主要功能：1. 利用测试集，根据评价指标生成各个模型评价矩阵
          2. 再测试集上对各个模型的预测进行集成，并且也进行相关的评估
          多语料模型分别再多个测试集评估
          多集成方法的评估，包括：
          1. 取各个模型预测的并集边界
          2. 对各个模型根据其在各类实体的表现评估生成权重矩阵，对预测结果进行加权平均预测
          3. 对个模型预测结果，首先取边界并集合并成大实体，然后取至少有两个模型支持的实体（只要模型预测的子字符串在大实体边界内就算一个）
使用场景：模型训练。每当模型更新后即可对各个模型进行评估生成评估的权重矩阵。

6. ensemblePrediction_all.py  # 结合评价矩阵，利用多语料多个模型对全量语料进行标注并进行相关的集成。
主要功能：1. 多语料训练出来的模型分别对全量数据进行标注预测。
         2. 利用模型评估矩阵，对标注的结果利用多种方式进行集成。
         3. 对置信度等进行计算整理并存储。
        
        集成方式包括：1）取各个模型预测的并集边界
        2） 对各个模型根据其在各类实体的表现评估生成权重矩阵，对预测结果进行加权平均预测
        3） 对个模型预测结果，首先取边界并集合并成大实体，然后取至少有两个模型支持的实体（只要模型预测的子字符串在大实体边界内就算一个）
        存储的格式：
            {'book': '器官移植分册.txt',
            'location': '|第1章肾移植|第十六节移植肾切除术',
            'paragraph': 'indications',
            'sentence': '2.移植肾破裂,无法修补者器官移植分册3.血管并发症治疗失败者',
            'entity1': '移植肾切除术',
            'seg': [['2.', 'm', [0, 2]],
              ['移植肾破裂', 'ds', [2, 7]],
              [',', 'x', [7, 8]],
              ['无法', 'n', [8, 10]],
              ['修补者', 'nr', [10, 13]],
              ['器官移植', 'sr', [13, 17]],
              ['分册', 'v', [17, 19]],
              ['3.', 'm', [19, 21]],
              ['血管', 'og', [21, 23]],
              ['并发症', 'ds', [23, 26]],
              ['治疗', 'v', [26, 28]],
              ['失败者', 'n', [28, 31]]],
            'ner': [['器官移植', 'SUR', [13, 17], [0.837152347912683, 0.9458935400001512]],
              ['血管', 'ORG', [21, 23], [0.7998752802310558, 0.8750970425641398]],
              ['并发症', 'DIS', [23, 26], [0.852185656717616, 0.9363446760837277]]],
            'source': 'm',
            'ind': 90046,
            'ensemble': [['移植', 'SUR', [2, 4]],
              ['器官移植', 'SUR', [13, 17]],
              ['血管', 'ORG', [21, 23]],
              ['并发症', 'DIS', [23, 26]],
              ['肾破裂', 'DIS', [4, 7]]],
            'entity1_type': 'SUR'}
          集成结果通过ensemble的key保存，而ner的key则保存全量语料模型"a"的预测结果。

使用场景：知识生产。在有了ner模型，评估矩阵的情况下，利用多语料模型预测，集成，生成标注结果。

7. clean_and_save.py  # 标注的后续处理工作，包括后期清洗，生成规则合并的实体，各个表的存储等
主要功能：标注后的后续处理工作。包括：ner结果与字典合并，依靠规则合并实体，清洗，各个结果表和中间表的存储，各个来源知识整合，最终存储到数据库。
            本代码包含以下内容
          * 字典匹配内容存储到结果表
          * 结果表字典和NER ensemble合并
          * 按照规则扩展实体边界
          * 存储和置信度
          * 临床指南结果整理，整合
          * 最后清理合并
          * 存储写入
          * NER RESULT规则清洗，存储，头实体存储
          
        本代码不包含：
        1. NER模型训练，预测，标注（除临床指南的数据）
        2. 临床指南的NER结果得到
        
使用场景：知识生产。# medical_knowledge_graph
